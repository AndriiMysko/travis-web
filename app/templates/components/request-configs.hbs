<TravisForm
  @onSubmit={{perform this.triggerBuild}}
  as |form|
>
  {{#if displayTriggerBuild}}
    <div class="trigger-build-buttons">
      {{#unless this.closed}}
        <a class="trigger-build-cancel" onclick={{action this.onCancel}}>Cancel</a>
        <a class="trigger-build-customize" onclick={{action this.onCustomize}}>Customize</a>
      {{/unless }}
      <button
        data-test-trigger-build-submit="true"
        onclick={{action this.onTriggerBuild}}
        type="button"
        class="trigger-build button--blue"
        title="Trigger build with your settings"
      >
        {{#if this.processing}}
          <LoadingIndicator />
        {{else}}
          Trigger build
        {{/if }}
      </button>
    </div>
    {{#unless this.closed}}
      <p>
        <SvgImage @name='rocket' @class='trigger-build-icon' />
        Trigger a build request with the following
        {{#if this.customize}}customized details and{{/if}}
        build {{pluralize this.rawConfigsCount 'config' without-count=true}}
      </p>
    {{/unless}}
    <div class="trigger-build-fields">
      <div class="form-elem">
        <form.field
          data-test-trigger-build-branch="true"
          @label="Branch"
          @placeholder="Select a branch"
          @value={{this.branch}}
          @showValidationStatusIcons={{false}}
          @onChange={{action (mut this.branch)}}
          as |field|
        >
          <field.select
            @search={{perform this.searchBranches}}
            as |branch|
          >
            {{branch}}
          </field.select>
        </form.field>
      </div>
      <div class="form-elem">
        <form.field
          data-test-trigger-build-sha="true"
          @label="Commit"
          @placeholder="Specify a Git sha (optiona)"
          @value={{this.sha}}
          @showValidationStatusIcons={{false}}
          @onChange={{action (mut this.sha)}}
          as |field|
        >
          {{field.input}}
        </form.field>
      </div>
      <div class="form-elem">
        <form.field
          data-test-trigger-build-message="true"
          @value={{this.message}}
          @label="Message"
          @onChange={{action (mut this.message)}}
          @placeholder="Overwrite the commit message (optional)"
          as |field|
        >
          {{field.input}}
        </form.field>
      </div>
      <div class="form-elem">
        <form.field
          data-test-trigger-build-config="true"
          @label="Build Config"
          as |field|
        >
          <div class="validation-result" onclick={{action toggleValidationMessages}}>
            {{#if this.validating}}
              <LoadingIndicator className="validating-indicator" />
            {{else}}
              {{#if this.validationResult}}
                <span class="build-messages-badge badge-{{this.validationResultLevel}}" />
                {{this.validationResult}}
              {{/if}}
              {{#if this.validationSummary}}
                <div class="validation-summary">
                  &mdash; {{this.validationSummary}}
                </div>
                <div class="toggle-validation-messages" />
              {{/if}}
            {{/if}}
          </div>
          {{#if this.displayValidationMessages}}
            <div class="yml-messages">
              {{#each this.validationMessages as |message|}}
                <RequestMessage @message={{message}} />
              {{/each}}
            </div>
          {{/if}}
          <div class="config-type {{this.configMode}}">
            <span class="yaml">YAML</span>
            <span class="javascript">JSON</span>
          </div>
          {{ivy-codemirror
            value=this.config
            valueUpdated=(action "setConfig")
            options=(hash
              mode=this.configMode
              lineNumbers=true
              tabSize=2
              indentWithTabs=false
              placeholder="Overwrite build config"
            )
          }}
        </form.field>
      </div>
      <div class="form-elem">
        <h4>
          Merge mode
        </h4>
        {{#radio-button value="deep_merge_append" groupValue=mergeMode}}
          Deep Merge & Append
        {{/radio-button}}
        {{#radio-button value="deep_merge_prepend" groupValue=mergeMode}}
          Deep Merge & Prepend
        {{/radio-button}}
        {{#radio-button value="deep_merge" groupValue=mergeMode}}
          Deep Merge
        {{/radio-button}}
        {{#radio-button value="merge" groupValue=mergeMode}}
          Merge
        {{/radio-button}}
        {{#radio-button value="replace" groupValue=mergeMode}}
          Replace
        {{/radio-button}}

        <ExternalLinkTo class="hint" href="{{config-get 'urls.triggerBuildMergeModes'}}">
          <SvgImage @name='icon-help' @class='icon-help' />
        </ExternalLinkTo>
      </div>

      {{#unless this.replacing}}
        <h4>
          Build Config
        </h4>
      {{/unless}}
    </div>
  {{/if}}

  {{#if this.closed}}
    <RequestMessagesList
      @request={{@request}}
      @viewMessage={{action (mut this.viewingMessage)}}
    />
  {{/if}}

  {{#each @request.uniqRawConfigs as |rawConfig|}}
    <RequestRawConfig
      @rawConfig={{rawConfig}}
      @build={{@request.build}}
      @slug={{@request.repo.slug}}
      @status={{this.status}}
      @mergeMode={{this.mergeMode}}
    />
  {{else}}
    <div class="starred-empty">
      The .travis.yml file used for this job is not available
    </div>
  {{/each}}

  {{#if this.closed}}
    <RequestConfig @config={{@request.config}} />
  {{/if}}
</TravisForm>
